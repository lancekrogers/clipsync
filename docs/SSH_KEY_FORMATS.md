# SSH Key Format Support in ClipSync

ClipSync supports multiple SSH key formats for authentication. This document describes the current support status and how to work with different key formats.

## Supported Key Formats

### ✅ Fully Supported

1. **PKCS8 Format (Recommended)**
   - Ed25519 keys in PKCS8 format
   - Generated by ClipSync or converted from other formats
   - Standard format that works reliably with the `ring` cryptography library

### ⚠️ Partially Supported

1. **OpenSSH Format**
   - Unencrypted Ed25519 keys: Basic parsing implemented, conversion to PKCS8 in progress
   - Detection and helpful error messages for unsupported variations

### ❌ Not Supported

1. **Encrypted Keys**
   - OpenSSH encrypted private keys
   - PKCS8 encrypted private keys
   - **Workaround**: Decrypt before use with `ssh-keygen -p -N "" -f <keyfile>`

2. **RSA Keys**
   - OpenSSH format RSA keys
   - PKCS#1 format RSA keys
   - **Workaround**: Convert to PKCS8 format using:
     ```bash
     # For OpenSSH format RSA keys
     ssh-keygen -p -m PKCS8 -f <keyfile>
     
     # For PKCS#1 format RSA keys
     openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in <keyfile> -out <keyfile>.pkcs8
     ```

3. **Other Key Types**
   - ECDSA keys
   - DSA keys (deprecated)

## Working with SSH Keys

### Generating Keys for ClipSync

The recommended approach is to generate keys using ClipSync itself:

```rust
use clipsync::auth::{KeyPair, KeyType};

let key_pair = KeyPair::generate(KeyType::Ed25519)?;
key_pair.save_to_file(&path).await?;
```

### Using Existing SSH Keys

If you have existing SSH keys generated with `ssh-keygen`:

1. **Check your key type**:
   ```bash
   ssh-keygen -l -f ~/.ssh/id_ed25519
   ```

2. **For Ed25519 keys**:
   - Unencrypted keys may work (partial support)
   - Encrypted keys must be decrypted first

3. **For RSA keys**:
   - Convert to PKCS8 format as shown above

### Error Messages

ClipSync provides helpful error messages when encountering unsupported formats:

- **Encrypted keys**: "Encrypted OpenSSH keys are not supported. Please decrypt your key first using: ssh-keygen -p -N \"\" -f <keyfile>"
- **RSA PKCS#1**: "RSA PKCS#1 private keys are not yet supported. Please convert to PKCS8 format using: openssl pkcs8 -topk8..."
- **RSA OpenSSH**: "RSA keys in OpenSSH format are not yet supported. Please convert to PKCS8 format using: ssh-keygen -p -m PKCS8..."

## Technical Details

### OpenSSH Format Structure

The OpenSSH private key format has the following structure:
- Magic bytes: "openssh-key-v1\0"
- Cipher name (e.g., "none" for unencrypted)
- KDF name and options
- Number of keys
- Public key data
- Private key data (check bytes, key type, public key, private key, comment, padding)

### PKCS8 Format Structure

PKCS8 is an ASN.1-based format:
- Version (0)
- Algorithm identifier (OID for Ed25519: 1.3.101.112)
- Private key data (nested OCTET STRING)

## Future Improvements

1. Complete OpenSSH format support for all unencrypted Ed25519 keys
2. Support for encrypted key files (with passphrase prompting)
3. RSA key support (both OpenSSH and PKCS8 formats)
4. Better key format auto-detection and conversion utilities

## Example Code

See `examples/test_openssh_keys.rs` for a complete example of working with different key formats in ClipSync.